<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - RGH</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background-color: #2c3e50; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .btn-delete { background: #e74c3c; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        .btn-delete:hover { background: #c0392b; }
    </style>
</head>
<body style="padding: 20px; font-family: 'Roboto', sans-serif; background-color: #f4f7f6;">

    <header class="app-header" style="background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <div class="logo" style="font-weight: bold; font-size: 1.2rem;">Rathnapura General Hospital (Admin)</div>
        <a href="{{ url_for('logout') }}" style="color: white; text-decoration: none; border: 1px solid white; padding: 5px 10px; border-radius: 4px;">Logout</a>
    </header>

    <section style="margin-top: 30px;">
        <h2>Current Appointments (Total: {{ total }})</h2>

        {% if appointments %}
        <table>
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Department</th>
                    <th>Date</th>
                    <th>Ref No</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for a in appointments %}
                <tr>
                    <td>{{ a['patient_name'] }}</td>
                    <td>{{ a['department'] }}</td>
                    <td>{{ a['appointment_date'] }}</td>
                    <td><strong>{{ a['reference_no'] }}</strong></td>
                    <td>
                        <button 
                            type="button" 
                            class="btn-delete" 
                            data-id="{{ a['id'] }}" 
                            onclick="deleteRow(this)">
                            Delete
                        </button>                    
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 50px; background: white; border-radius: 8px; margin-top: 20px;">
            <p style="color: #7f8c8d;">No appointments found in the database.</p>
        </div>
        {% endif %}
    </section>

    <script>
        function deleteRow(appointmentId, btn) {
            if (!appointmentId || appointmentId === 'None') {
                alert("Error: Invalid Appointment ID");
                return;
            }

            if (confirm("Are you sure you want to delete this appointment?")) {
                fetch(`/admin/delete/${appointmentId}`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Smoothly remove the row
                        const row = btn.closest('tr');
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 300);
                    } else {
                        alert("Error: could not delete from database.");
                    }
                })
                .catch(err => {
                    console.error("Fetch error:", err);
                    alert("Server error. Please check your console.");
                });
            }
        }
    </script>
</body>
</html>